#! Generated by VisualDCT v2.6
#! DBDSTART
#! DBD("../../dbd/NSLS-II-SST1.dbd")
#! DBDEND


record(motor, "$(SYS){$(DEV)-$(AXIS)}-Mtr") {
  field(DTYP, "asynMotor")
  field(OUT, "@asyn($(COORDPORT),$(S))")
  field(EGU, "um")
  field(DESC, "Gap virtual motor")
  field(MRES, "$(MRES)")
  field(RTRY, "0")
  field(NTM, "NO")
  field(VELO, "$(VELOCITY)")
  field(ACCL, "$(ACCEL)")
  field(PREC, "2")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}Taper-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Measured gap taper")
  field(SCAN, "1 second")
  field(EGU, "um")
  field(INP, "@asyn(PMAC_REG_PORT)var(P209)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}MaxGap-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Maximum Gap")
  field(SCAN, "Passive")
  field(EGU, "um")
  field(PINI, "RUNNING")
  field(INP, "@asyn(PMAC_REG_PORT)var(P1031)scale($(CTS_PER_EGU))")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}MaxGap-SP") {
  field(DTYP, "asynFloat64")
  field(DESC, "Maximum Gap")
  field(SCAN, "Passive")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}MaxGap-RB")
  field(EGU, "um")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P1031)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(transform, "$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass") {
  field(SCAN, "Passive")
  field(INPA, "$(SYS){$(DEV)-$(AXIS)}MaxGap-RB")
  field(OUTA, "$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVH")
  field(CLCA, "A")
  field(CLCB, "A")
  field(OUTB, "$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.HOPR")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}MinGap-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Minimum Gap")
  field(SCAN, "Passive")
  field(EGU, "um")
  field(PINI, "RUNNING")
  field(INP, "@asyn(PMAC_REG_PORT)var(P1032)scale($(CTS_PER_EGU))")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}MinGap-Pass")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}MinGap-SP") {
  field(DTYP, "asynFloat64")
  field(DESC, "Minimum Gap")
  field(SCAN, "Passive")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}MinGap-RB")
  field(EGU, "um")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P1032)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(transform, "$(SYS){$(DEV)-$(AXIS)}MinGap-Pass") {
  field(SCAN, "Passive")
  field(INPA, "$(SYS){$(DEV)-$(AXIS)}MinGap-RB")
  field(OUTA, "$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVL")
  field(CLCA, "A")
  field(CLCB, "A")
  field(OUTB, "$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.LOPR")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}ReqCenter-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Requested Operator Offset")
  field(SCAN, "Passive")
  field(EGU, "um")
  field(PINI, "RUNNING")
  field(INP, "@asyn(PMAC_REG_PORT)var(P206)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP") {
  field(DTYP, "asynFloat64")
  field(DESC, "Requested Operator Offset")
  field(SCAN, "Passive")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}ReqCenter-RB")
  field(EGU, "um")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P206)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}ReqTaper-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Requested Operator Taper")
  field(SCAN, "Passive")
  field(EGU, "um")
  field(PINI, "RUNNING")
  field(INP, "@asyn(PMAC_REG_PORT)var(P207)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP") {
  field(DTYP, "asynFloat64")
  field(DESC, "Requested Operator Taper")
  field(SCAN, "Passive")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}ReqTaper-RB")
  field(EGU, "um")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P207)scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}-Mtr-SP") {
  field(DTYP, "asynFloat64")
  field(DESC, "Motor position setpoint,limits included.")
  field(SCAN, "Passive")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P1112)scale($(CTS_PER_EGU))")
  field(EGU, "um")
  field(PREC, "2")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}-MtrCalc")
}

record(ai, "$(SYS){$(DEV)-$(AXIS)}Center-RB") {
  field(DTYP, "asynFloat64")
  field(DESC, "Measured gap center offset")
  field(SCAN, "1 second")
  field(EGU, "um")
  field(INP, "@asyn(PMAC_REG_PORT)var(P208))scale($(CTS_PER_EGU))")
  field(PREC, "2")
}

record(asyn, "$(SYS){$(DEV)-$(AXIS)}-MvReq-Cmd") {
  field(DESC, "Trigers PLC to start gap movement")
  field(SCAN, "Passive")
  field(DTYP, "asynRecordDevice")
  field(PORT, "$(PMACPORT)")
  field(ADDR, "-1")
  field(TMOD, "Write/Read")
  field(AOUT, "P1111=1")
}

record(transform, "$(SYS){$(DEV)-$(AXIS)}-MtrCalc") {
  field(INPA, "$(SYS){$(DEV)-$(AXIS)}-Mtr.VELO PP NMS")
  field(INPB, "$(SYS){$(DEV)-$(AXIS)}-Mtr.ACCL PP NMS")
  field(OUTA, "$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO PP NMS")
  field(OUTB, "$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL PP NMS")
  field(FLNK, "$(SYS){$(DEV)-$(AXIS)}-MvReq-Cmd")
  field(CLCA, "A")
  field(CLCB, "B")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO") {
  field(DTYP, "asynFloat64")
  field(DESC, "Sends motor VELO to PMAC")
  field(SCAN, "Passive")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P1114)scale($(CTS_PER_EGU))")
  field(EGU, "um/s")
  field(PREC, "2")
}

record(ao, "$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL") {
  field(DTYP, "asynFloat64")
  field(DESC, "Sends motor ACCL to PMAC")
  field(SCAN, "Passive")
  field(OUT, "@asyn(PMAC_REG_PORT)var(P1115)")
  field(EGU, "um/s^2")
  field(PREC, "2")
}

#! Further lines contain data used by VisualDCT
#! View(126,256,1.0)
#! Record("$(SYS){$(DEV)-$(AXIS)}-Mtr",880,385,0,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr.VELO",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr.VELO")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr.ACCL",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr.ACCL")
#! Record("$(SYS){$(DEV)-$(AXIS)}Taper-RB",800,1760,0,0,"$(SYS){$(DEV)-$(AXIS)}Taper-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}MaxGap-RB",220,412,0,0,"$(SYS){$(DEV)-$(AXIS)}MaxGap-RB")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.FLNK",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.FLNK","$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.VAL",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.VAL")
#! Record("$(SYS){$(DEV)-$(AXIS)}MaxGap-SP",220,646,0,0,"$(SYS){$(DEV)-$(AXIS)}MaxGap-SP")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-SP.FLNK",16777215,0,"$(SYS){$(DEV)-$(AXIS)}MaxGap-SP.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}MaxGap-SP.FLNK","$(SYS){$(DEV)-$(AXIS)}MaxGap-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass",520,520,0,0,"$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.INPA",16777215,0,"$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.INPA")
#! Link("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.INPA","$(SYS){$(DEV)-$(AXIS)}MaxGap-RB.VAL")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTA",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTA")
#! Link("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTA","$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVH")
#! Field("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTB",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTB")
#! Link("$(SYS){$(DEV)-$(AXIS)}MaxGap-Pass.OUTB","$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.HOPR")
#! Record("$(SYS){$(DEV)-$(AXIS)}MinGap-RB",220,899,0,0,"$(SYS){$(DEV)-$(AXIS)}MinGap-RB")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-RB.FLNK",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MinGap-RB.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}MinGap-RB.FLNK","$(SYS){$(DEV)-$(AXIS)}MinGap-Pass")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-RB.VAL",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MinGap-RB.VAL")
#! Record("$(SYS){$(DEV)-$(AXIS)}MinGap-SP",240,1146,0,0,"$(SYS){$(DEV)-$(AXIS)}MinGap-SP")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-SP.FLNK",16777215,0,"$(SYS){$(DEV)-$(AXIS)}MinGap-SP.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}MinGap-SP.FLNK","$(SYS){$(DEV)-$(AXIS)}MinGap-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass",540,960,0,0,"$(SYS){$(DEV)-$(AXIS)}MinGap-Pass")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.INPA",16777215,0,"$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.INPA")
#! Link("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.INPA","$(SYS){$(DEV)-$(AXIS)}MinGap-RB.VAL")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTA",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTA")
#! Link("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTA","$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVL")
#! Field("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTB",16777215,1,"$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTB")
#! Link("$(SYS){$(DEV)-$(AXIS)}MinGap-Pass.OUTB","$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.LOPR")
#! Record("$(SYS){$(DEV)-$(AXIS)}ReqCenter-RB",120,1532,0,0,"$(SYS){$(DEV)-$(AXIS)}ReqCenter-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP",360,1546,0,0,"$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP")
#! Field("$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP.FLNK",16777215,0,"$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}ReqCenter-SP.FLNK","$(SYS){$(DEV)-$(AXIS)}ReqCenter-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}ReqTaper-RB",120,1746,0,0,"$(SYS){$(DEV)-$(AXIS)}ReqTaper-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP",360,1746,0,0,"$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP")
#! Field("$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP.FLNK",16777215,0,"$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}ReqTaper-SP.FLNK","$(SYS){$(DEV)-$(AXIS)}ReqTaper-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP",1000,686,0,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVH",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVH")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.HOPR",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.HOPR")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVL",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.DRVL")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.LOPR",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.LOPR")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.OUT",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.OUT")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.FLNK",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}-Mtr-SP.FLNK","$(SYS){$(DEV)-$(AXIS)}-MtrCalc")
#! Record("$(SYS){$(DEV)-$(AXIS)}Center-RB",800,1560,0,0,"$(SYS){$(DEV)-$(AXIS)}Center-RB")
#! Record("$(SYS){$(DEV)-$(AXIS)}-MvReq-Cmd",1600,866,0,0,"$(SYS){$(DEV)-$(AXIS)}-MvReq-Cmd")
#! Record("$(SYS){$(DEV)-$(AXIS)}-MtrCalc",1320,426,0,0,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc")
#! Field("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPA",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPA")
#! Link("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPA","$(SYS){$(DEV)-$(AXIS)}-Mtr.VELO")
#! Field("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPB",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPB")
#! Link("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.INPB","$(SYS){$(DEV)-$(AXIS)}-Mtr.ACCL")
#! Field("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTA",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTA")
#! Link("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTA","$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO.VAL")
#! Field("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTB",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTB")
#! Link("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.OUTB","$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL.VAL")
#! Field("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.FLNK",16777215,1,"$(SYS){$(DEV)-$(AXIS)}-MtrCalc.FLNK")
#! Link("$(SYS){$(DEV)-$(AXIS)}-MtrCalc.FLNK","$(SYS){$(DEV)-$(AXIS)}-MvReq-Cmd")
#! Record("$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO",1680,320,0,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO.VAL",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-VELO.VAL")
#! Record("$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL",1680,500,0,1,"$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL")
#! Field("$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL.VAL",16777215,0,"$(SYS){$(DEV)-$(AXIS)}-Mtr-ACCL.VAL")
#! Box(Box0,40,20,780,280,0,16776960,Border0)
#! TextBox(TB0,60,40,760,260,0,"Dialog",24,1,16777215,"Gap movement\n\nAuthors: Ivo List, Miroslav Pavleski, Miha Vitoroviƒç\n\nCosylab d.d.\nhttp://www.cosylab.com",Border0)
#! Box(Box2,40,1400,1100,2080,0,6710784,null)
#! Box(Box1,860,300,1920,1320,0,3407616,null)
#! TextBox(TB4,60,1420,940,1460,0,"Dialog",26,1,16777215,"Gap movement intentional center offset & taper\n",null)
#! TextBox(TB3,1020,980,1420,1260,0,"Dialog",12,1,16777215,"HLM LLM on motor record are useless. Hence intermediate setpoint ao record is used to limit the values.\n\nIf motor record HLM is 240000 and user positions the motor at 240000 the motor goes to 240000 and stops. Then as the record processes with time it goes into infinite loop:\n\n - Record detects we are at limit\n - Sets LVIO to 1 (Limit violation flag)\n - Record detects LVIO is 1 , issues a stop\n - Stop clears LVIO to 0 \n - Repeat ...\n \nThis in essence prevents movement once we are at limit position. Every move command is interrupted by STOP request from the record.",null)
#! TextBox(TB2,1040,380,1320,500,0,"Dialog",12,1,16777215,"NTM=\"NO\" and RTRY=0 is really important for Gap motion. \n\nIt prevents the motor record from issuing a premature stop when gap is at position and is doing the final taper movement.",null)
#! TextBox(TB1,860,300,1580,380,0,"Dialog",26,1,16777215,"Gap MOTOR RECORD and \nmovement setpoint",null)
#! TextBox(TB8,1600,820,1900,880,0,"Dialog",12,1,16777215,"This record writes a flag that notifies the movement request PLC (PLC 8) that it should execute new movement.\n",null)
#! TextBox(TB7,160,2040,1020,2080,0,"Dialog",22,1,16711680,"Note: Intentional taper is applied at end of gap movement.",null)
#! TextBox(TB6,680,1500,1120,1540,0,"Dialog",22,1,16777215,"Current offset & taper readback",null)
#! TextBox(TB5,120,1500,580,1540,0,"Dialog",22,1,16777215,"Requested offset & taper setpoints",null)
